

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Making Your Own Weighted Difference Map &mdash; reciprocalspaceship 1.0.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=5712473c" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
    <link rel="shortcut icon" href="../_static/rs-favicon_32x32.png"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=46dfa7f5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            reciprocalspaceship
              <img src="../_static/rs.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../userguide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers/index.html">For Developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">reciprocalspaceship</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Making Your Own Weighted Difference Map</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/7_makingADifferenceMap.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
  This page was generated from
  <a class="reference external" href="https://github.com/rs-station/reciprocalspaceship/blob/main/docs/examples/7_makingADifferenceMap.ipynb">docs/examples/7_makingADifferenceMap.ipynb</a>.
  Interactive online version:
  <span style="white-space: nowrap;">
    <a href="https://mybinder.org/v2/gh/rs-station/reciprocalspaceship/main?filepath=docs/examples/7_makingADifferenceMap.ipynb?urlpath=lab">
    <img alt="Binder badge" src="https://mybinder.org/badge_logo.svg" style="vertical-align:text-bottom"></a>.
  </span>
</div><section id="Making-Your-Own-Weighted-Difference-Map">
<h1>Making Your Own Weighted Difference Map<a class="headerlink" href="#Making-Your-Own-Weighted-Difference-Map" title="Link to this heading"></a></h1>
<p>A common methodology for investigating structural changes in change-of-state crystallography experiments is using difference maps between structure factor amplitudes collected with and without a perturbation. These <span class="math notranslate nohighlight">\((|F_{On}| - |F_{Off}|)\)</span> maps may be noisy due to systematic errors or scaling artifacts, and have historically been weighted based on the magnitude of the difference signal and/or the error estimates associated with the measured values.</p>
<p>In the previous notebook, we used PYP data to make a weighted difference map. This notebook is a template to allow you to make your own difference map using your own data.</p>
<div class="alert alert-block alert-info"><p>Note: To run this, you will be uploading MTZ files to this notebook. Although these files will be on a server temporarily, they are deleted once this notebook is closed.</p>
</div><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;notebook&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.4</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">reciprocalspaceship</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rs</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.0.7
</pre></div></div>
</div>
<hr class="docutils" />
<section id="Load-On-and-Off-DataSets">
<h2>Load <code class="docutils literal notranslate"><span class="pre">On</span></code> and <code class="docutils literal notranslate"><span class="pre">Off</span></code> DataSets<a class="headerlink" href="#Load-On-and-Off-DataSets" title="Link to this heading"></a></h2>
<p>You will specify <code class="docutils literal notranslate"><span class="pre">On</span></code> and <code class="docutils literal notranslate"><span class="pre">Off</span></code> MTZ files that are uploaded to this notebook. It is assumed that there is exactly one column in each MTZ containing structure factors and one column containing uncertainties in those structure factors. If there are multiple columns with each data type, only the first will be used.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;On MTZ:&quot;</span><span class="p">)</span>
<span class="n">uploader_on</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FileUpload</span><span class="p">(</span><span class="n">accept</span><span class="o">=</span><span class="s2">&quot;.mtz&quot;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">uploader_on</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Off MTZ:&quot;</span><span class="p">)</span>
<span class="n">uploader_off</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FileUpload</span><span class="p">(</span><span class="n">accept</span><span class="o">=</span><span class="s2">&quot;.mtz&quot;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">uploader_off</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
On MTZ:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "e9c9d93a2efd42389b45c11482b5122d"}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Off MTZ:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "5aa7df325ff741939768988c31465567"}</script></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">read_uploadedFile</span><span class="p">(</span><span class="n">uploadedFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use temporary file to read uploaded data&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
    <span class="n">upload</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;mtz&quot;</span><span class="p">)</span>
    <span class="n">upload</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">uploadedFile</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mtz</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">read_mtz</span><span class="p">(</span><span class="n">upload</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">upload</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mtz</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mtz_on</span>  <span class="o">=</span> <span class="n">read_uploadedFile</span><span class="p">(</span><span class="n">uploader_on</span><span class="p">)</span>
<span class="n">mtz_off</span> <span class="o">=</span> <span class="n">read_uploadedFile</span><span class="p">(</span><span class="n">uploader_off</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[6]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> mtz_on  = <span class="ansi-yellow-bg">read_uploadedFile</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">uploader_on</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      2</span> mtz_off = read_uploadedFile(uploader_off)

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[5]</span><span class="ansi-green-fg">, line 5</span>, in <span class="ansi-cyan-fg">read_uploadedFile</span><span class="ansi-blue-fg">(uploadedFile)</span>
<span class="ansi-green-fg">      3</span> <span class="ansi-bold" style="color: rgb(0,135,0)">from</span><span style="color: rgb(188,188,188)"> </span><span class="ansi-blue-intense-fg ansi-bold">tempfile</span><span style="color: rgb(188,188,188)"> </span><span class="ansi-bold" style="color: rgb(0,135,0)">import</span> NamedTemporaryFile
<span class="ansi-green-fg">      4</span> upload = NamedTemporaryFile(suffix=<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">mtz</span><span class="ansi-yellow-fg">&#34;</span>)
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">5</span> upload.write(<span class="ansi-yellow-bg">uploadedFile</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">data</span>[<span class="ansi-green-fg">0</span>])
<span class="ansi-green-fg">      6</span> mtz = rs.read_mtz(upload.name)
<span class="ansi-green-fg">      7</span> upload.close()

<span class="ansi-red-fg">AttributeError</span>: &#39;FileUpload&#39; object has no attribute &#39;data&#39;
</pre></div></div>
</div>
<p>The on file looks like this:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mtz_on</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[7]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span class="ansi-yellow-bg">mtz_on</span>

<span class="ansi-red-fg">NameError</span>: name &#39;mtz_on&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">subset_to_F_and_SigF</span><span class="p">(</span><span class="n">mtz</span><span class="p">):</span>
    <span class="n">F_column</span> <span class="o">=</span> <span class="p">[</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">mtz</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">mtz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">mtztype</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">]</span>
    <span class="n">SigF_column</span> <span class="o">=</span> <span class="p">[</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">mtz</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">mtz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">mtztype</span> <span class="o">==</span> <span class="s2">&quot;Q&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mtz</span><span class="p">[[</span><span class="n">F_column</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SigF_column</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mtz_on</span> <span class="o">=</span> <span class="n">subset_to_F_and_SigF</span><span class="p">(</span><span class="n">mtz_on</span><span class="p">)</span>
<span class="n">mtz_off</span> <span class="o">=</span> <span class="n">subset_to_F_and_SigF</span><span class="p">(</span><span class="n">mtz_off</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[9]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> mtz_on = subset_to_F_and_SigF(<span class="ansi-yellow-bg">mtz_on</span>)
<span class="ansi-green-fg">      2</span> mtz_off = subset_to_F_and_SigF(mtz_off)

<span class="ansi-red-fg">NameError</span>: name &#39;mtz_on&#39; is not defined
</pre></div></div>
</div>
<p>Since difference maps can only be made with Fourier magnitudes that were measured in both datasets, we will subset the datasets to their common Miller indices.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">mtz_off</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mtz_on</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_off&quot;</span><span class="p">,</span> <span class="s2">&quot;_on&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[10]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> diff = <span class="ansi-yellow-bg">mtz_off</span>.merge(mtz_on, left_index=<span class="ansi-bold" style="color: rgb(0,135,0)">True</span>, right_index=<span class="ansi-bold" style="color: rgb(0,135,0)">True</span>, suffixes=(<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">_off</span><span class="ansi-yellow-fg">&#34;</span>, <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">_on</span><span class="ansi-yellow-fg">&#34;</span>))

<span class="ansi-red-fg">NameError</span>: name &#39;mtz_off&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[11]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span class="ansi-yellow-bg">diff</span>.head()

<span class="ansi-red-fg">NameError</span>: name &#39;diff&#39; is not defined
</pre></div></div>
</div>
</section>
<hr class="docutils" />
<section id="Compute-Difference-Map-Coefficients-and-Errors">
<h2>Compute Difference Map Coefficients and Errors<a class="headerlink" href="#Compute-Difference-Map-Coefficients-and-Errors" title="Link to this heading"></a></h2>
<p>We will compute <span class="math notranslate nohighlight">\((|F_{On}| - |F_{Off}|)\)</span> for use as the coefficients of the difference map, and we will propagate the uncertainties in quadrature. These propagated uncertainties will be used when computing weights for each Miller index.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;F_on&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;F_off&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;SFAmplitude&quot;</span><span class="p">)</span>
<span class="n">diff</span><span class="p">[</span><span class="s2">&quot;SigDF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;SigF_on&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;SigF_off&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;Stddev&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[12]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">DF</span><span class="ansi-yellow-fg">&#34;</span>] = (<span class="ansi-yellow-bg">diff</span>[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">F_on</span><span class="ansi-yellow-fg">&#34;</span>] - diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">F_off</span><span class="ansi-yellow-fg">&#34;</span>]).astype(<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">SFAmplitude</span><span class="ansi-yellow-fg">&#34;</span>)
<span class="ansi-green-fg">      2</span> diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">SigDF</span><span class="ansi-yellow-fg">&#34;</span>] = np.sqrt(diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">SigF_on</span><span class="ansi-yellow-fg">&#34;</span>]**<span class="ansi-green-fg">2</span> + diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">SigF_off</span><span class="ansi-yellow-fg">&#34;</span>]**<span class="ansi-green-fg">2</span>).astype(<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">Stddev</span><span class="ansi-yellow-fg">&#34;</span>)

<span class="ansi-red-fg">NameError</span>: name &#39;diff&#39; is not defined
</pre></div></div>
</div>
</section>
<hr class="docutils" />
<section id="Compute-Difference-Map-Weights">
<h2>Compute Difference Map Weights<a class="headerlink" href="#Compute-Difference-Map-Weights" title="Link to this heading"></a></h2>
<p>There are several weighting schemes that have been used to produce time-resolved difference maps. Many of them take the form below, involving a term based on the uncertainty in the difference structure factor amplitude (<span class="math notranslate nohighlight">\(\sigma_{\Delta F}\)</span>), and optionally, a scale term based on the the magnitude of the observed <span class="math notranslate nohighlight">\(\Delta F\)</span>. With <span class="math notranslate nohighlight">\(\alpha=0\)</span>, these weights take the form employed in <a class="reference external" href="https://scripts.iucr.org/cgi-bin/paper?he0183">Ursby and Bourgeois, Acta Cryst (1997)</a>. On the
other hand, <a class="reference external" href="https://pubs.acs.org/doi/10.1021/bi010715u">Šrajer et al, Biochemistry (2001)</a> employed weights with <span class="math notranslate nohighlight">\(\alpha=1\)</span> in order to decrease the impact of abnormally large values of <span class="math notranslate nohighlight">\(\Delta F\)</span> that may have erroneously small uncertainties. Finally, other weighting schemes have employed intermediate values of <span class="math notranslate nohighlight">\(\alpha\)</span> (<a class="reference external" href="https://www.nature.com/articles/nature20571">Hekstra et al, Nature (2016)</a>).</p>
<p><span class="math">\begin{equation}
w = \left(1 + \frac{\sigma_{\Delta F}^2}{\overline{\sigma_{\Delta F}^2}} + \alpha\frac{|\Delta F|^2}{\overline{ |\Delta F|^2 }} \right)^{-1}
\end{equation}</span></p>
<p>For illustration purposes, we will compute weights with <span class="math notranslate nohighlight">\(\alpha=0.05\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_weights</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sigdf</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute weights for each structure factor based on deltaF and its uncertainty</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigdf</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigdf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">w</span><span class="o">**-</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_weights</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="s2">&quot;DF&quot;</span><span class="p">],</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;SigDF&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.00</span><span class="p">)</span>
<span class="n">diff</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span><span class="p">[</span><span class="s2">&quot;W&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;W&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[14]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">W</span><span class="ansi-yellow-fg">&#34;</span>] = compute_weights(<span class="ansi-yellow-bg">diff</span>[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">DF</span><span class="ansi-yellow-fg">&#34;</span>], diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">SigDF</span><span class="ansi-yellow-fg">&#34;</span>], alpha=<span class="ansi-green-fg">0.00</span>)
<span class="ansi-green-fg">      2</span> diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">W</span><span class="ansi-yellow-fg">&#34;</span>] = diff[<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">W</span><span class="ansi-yellow-fg">&#34;</span>].astype(<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">W</span><span class="ansi-yellow-fg">&#34;</span>)

<span class="ansi-red-fg">NameError</span>: name &#39;diff&#39; is not defined
</pre></div></div>
</div>
<p>Let’s visualize the weights relative to the magnitude of <span class="math notranslate nohighlight">\(\Delta F\)</span> and the signal-to-noise ratio in order to understand how they will affect different structure factors.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">pts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">DF</span><span class="p">,</span> <span class="n">diff</span><span class="o">.</span><span class="n">DF</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">/</span><span class="n">diff</span><span class="o">.</span><span class="n">SigDF</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">diff</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta F$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\frac{\left| \Delta F \right|}{\sigma_{\Delta F}}$&quot;</span><span class="p">)</span>

<span class="c1"># Inset</span>
<span class="n">axins</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.37</span><span class="p">,</span> <span class="mf">0.37</span><span class="p">])</span>
<span class="n">axins</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">DF</span><span class="p">,</span> <span class="n">diff</span><span class="o">.</span><span class="n">DF</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">/</span><span class="n">diff</span><span class="o">.</span><span class="n">SigDF</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">diff</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
<span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<span class="n">axins</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">indicate_inset_zoom</span><span class="p">(</span><span class="n">axins</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Weight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[15]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> fig, ax = plt.subplots(figsize=(<span class="ansi-green-fg">10</span>, <span class="ansi-green-fg">7</span>))
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> pts = ax.scatter(<span class="ansi-yellow-bg">diff</span>.DF, diff.DF.abs()/diff.SigDF, c=diff.W)
<span class="ansi-green-fg">      3</span> x1, x2 = plt.gca().get_xlim()
<span class="ansi-green-fg">      4</span> ax.set_xlim(x1-<span class="ansi-green-fg">0.5</span>, x2+<span class="ansi-green-fg">0.5</span>)

<span class="ansi-red-fg">NameError</span>: name &#39;diff&#39; is not defined
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_7_makingADifferenceMap_21_1.png" src="../_images/examples_7_makingADifferenceMap_21_1.png" />
</div>
</div>
<p>As seen in the above plot, difference Fourier coefficients with low signal-to-noise ratios (large <span class="math notranslate nohighlight">\(\sigma_{\Delta F}\)</span> relative to <span class="math notranslate nohighlight">\(|\Delta F|\)</span>) are assigned lower weight. Difference Fourier coefficients with large amplitude are also assigned lower weight.</p>
</section>
<hr class="docutils" />
<section id="Phasing-the-Difference-Map">
<h2>Phasing the Difference Map<a class="headerlink" href="#Phasing-the-Difference-Map" title="Link to this heading"></a></h2>
<p>We have our difference Fourier amplitudes and weights, so we just need phases in order to make a difference map. We will use the phases from an uploaded MTZ file – this should correspond to an isomorphous refined structure for the system of interest. If a column named <code class="docutils literal notranslate"><span class="pre">PH2FOFCWT</span></code> is defined, it is used. Otherwise, the first column of phases is used.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reference MTZ with Phases:&quot;</span><span class="p">)</span>
<span class="n">uploader_ref</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FileUpload</span><span class="p">(</span><span class="n">accept</span><span class="o">=</span><span class="s2">&quot;.mtz&quot;</span><span class="p">,</span> <span class="n">multiple</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">uploader_ref</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Reference MTZ with Phases:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "43e279e6b2524f1594c4798bdac82324"}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mtz_ref</span> <span class="o">=</span> <span class="n">read_uploadedFile</span><span class="p">(</span><span class="n">uploader_ref</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[17]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> mtz_ref = <span class="ansi-yellow-bg">read_uploadedFile</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">uploader_ref</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[5]</span><span class="ansi-green-fg">, line 5</span>, in <span class="ansi-cyan-fg">read_uploadedFile</span><span class="ansi-blue-fg">(uploadedFile)</span>
<span class="ansi-green-fg">      3</span> <span class="ansi-bold" style="color: rgb(0,135,0)">from</span><span style="color: rgb(188,188,188)"> </span><span class="ansi-blue-intense-fg ansi-bold">tempfile</span><span style="color: rgb(188,188,188)"> </span><span class="ansi-bold" style="color: rgb(0,135,0)">import</span> NamedTemporaryFile
<span class="ansi-green-fg">      4</span> upload = NamedTemporaryFile(suffix=<span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">mtz</span><span class="ansi-yellow-fg">&#34;</span>)
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">5</span> upload.write(<span class="ansi-yellow-bg">uploadedFile</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">data</span>[<span class="ansi-green-fg">0</span>])
<span class="ansi-green-fg">      6</span> mtz = rs.read_mtz(upload.name)
<span class="ansi-green-fg">      7</span> upload.close()

<span class="ansi-red-fg">AttributeError</span>: &#39;FileUpload&#39; object has no attribute &#39;data&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phases</span> <span class="o">=</span> <span class="n">mtz_ref</span><span class="o">.</span><span class="n">get_phase_keys</span><span class="p">()</span>
<span class="k">if</span> <span class="s2">&quot;PH2FOFCWT&quot;</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="s2">&quot;PH2FOFCWT&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[18]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> phases = <span class="ansi-yellow-bg">mtz_ref</span>.get_phase_keys()
<span class="ansi-green-fg">      2</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">PH2FOFCWT</span><span class="ansi-yellow-fg">&#34;</span> <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> phases:
<span class="ansi-green-fg">      3</span>     phi = <span class="ansi-yellow-fg">&#34;</span><span class="ansi-yellow-fg">PH2FOFCWT</span><span class="ansi-yellow-fg">&#34;</span>

<span class="ansi-red-fg">NameError</span>: name &#39;mtz_ref&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mtz_ref</span><span class="p">[</span><span class="n">phi</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[19]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> diff = <span class="ansi-yellow-bg">diff</span>.merge(mtz_ref[phi], left_index=<span class="ansi-bold" style="color: rgb(0,135,0)">True</span>, right_index=<span class="ansi-bold" style="color: rgb(0,135,0)">True</span>)

<span class="ansi-red-fg">NameError</span>: name &#39;diff&#39; is not defined
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[20]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span class="ansi-yellow-bg">diff</span>

<span class="ansi-red-fg">NameError</span>: name &#39;diff&#39; is not defined
</pre></div></div>
</div>
<p>The object <code class="docutils literal notranslate"><span class="pre">diff</span></code> can now be written to an MTZ file and downloaded to view offline in your GUI of choice – we will first make a “download” button.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DownloadButton</span><span class="p">(</span><span class="n">ipywidgets</span><span class="o">.</span><span class="n">Button</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download button with dynamic content</span>

<span class="sd">    The content is generated using a callback when the button is clicked.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contents</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DownloadButton</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__on_click</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__on_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">contents</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">()</span>
        <span class="n">b64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">encodebytes</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">b64</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># bypass browser cache</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;dl_</span><span class="si">{</span><span class="n">digest</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">&lt;body&gt;</span>
<span class="s2">&lt;a id=&quot;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot; download=&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot; href=&quot;data:text/csv;base64,</span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot; download&gt;</span>
<span class="s2">&lt;/a&gt;</span>

<span class="s2">&lt;script&gt;</span>
<span class="s2">(function download() </span><span class="se">{{</span>
<span class="s2">document.getElementById(&#39;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&#39;).click();</span>
<span class="se">}}</span><span class="s2">)()</span>
<span class="s2">&lt;/script&gt;</span>

<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">getDiffMap</span><span class="p">(</span><span class="n">mtz</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="n">download</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;mtz&quot;</span><span class="p">)</span>
    <span class="n">mtz</span><span class="o">.</span><span class="n">write_mtz</span><span class="p">(</span><span class="n">download</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">download</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">download</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

<span class="n">DownloadButton</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;diffmap.mtz&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">getDiffMap</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;download&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "ec68f861207048dc965a9a4f19709332"}</script></div>
</div>
<p>Good luck with your weighted difference map!</p>
<script type="application/vnd.jupyter.widget-state+json">
{"state": {"3c06557d96db4195a691bd557f0da325": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "e9255bf545c248b98bad27f4cb7ab1bd": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "e9c9d93a2efd42389b45c11482b5122d": {"model_name": "FileUploadModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "FileUploadModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "FileUploadView", "accept": ".mtz", "button_style": "", "description": "Upload", "description_allow_html": false, "disabled": false, "error": "", "icon": "upload", "layout": "IPY_MODEL_3c06557d96db4195a691bd557f0da325", "multiple": false, "style": "IPY_MODEL_e9255bf545c248b98bad27f4cb7ab1bd", "tabbable": null, "tooltip": null, "value": []}}, "a67708feefbf47718be65e0fe2fd5ff1": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "98fef694866c40f1b24d71ada2a89932": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "5aa7df325ff741939768988c31465567": {"model_name": "FileUploadModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "FileUploadModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "FileUploadView", "accept": ".mtz", "button_style": "", "description": "Upload", "description_allow_html": false, "disabled": false, "error": "", "icon": "upload", "layout": "IPY_MODEL_a67708feefbf47718be65e0fe2fd5ff1", "multiple": false, "style": "IPY_MODEL_98fef694866c40f1b24d71ada2a89932", "tabbable": null, "tooltip": null, "value": []}}, "29a5fabca61e4ee697d6d308c3c4ffcf": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "dde559fac35e43879154331fe3ace1f4": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "43e279e6b2524f1594c4798bdac82324": {"model_name": "FileUploadModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "FileUploadModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "FileUploadView", "accept": ".mtz", "button_style": "", "description": "Upload", "description_allow_html": false, "disabled": false, "error": "", "icon": "upload", "layout": "IPY_MODEL_29a5fabca61e4ee697d6d308c3c4ffcf", "multiple": false, "style": "IPY_MODEL_dde559fac35e43879154331fe3ace1f4", "tabbable": null, "tooltip": null, "value": []}}, "d22c7032eb484a2a99cde25653582902": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "036c3a1f60ec4ce0ad744c7b892cd4ce": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "ec68f861207048dc965a9a4f19709332": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "download", "disabled": false, "icon": "", "layout": "IPY_MODEL_d22c7032eb484a2a99cde25653582902", "style": "IPY_MODEL_036c3a1f60ec4ce0ad744c7b892cd4ce", "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}
</script></section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Jack B. Greisman, Kevin M. Dalton.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>